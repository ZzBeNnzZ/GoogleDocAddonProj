<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100..900&display=swap" rel="stylesheet">
  <style>
    :root { --expected-color:#8888ff; --actual-color:#66cc66; }
    body {
      margin:0; padding:0; overflow-x:hidden;
      font-family:'Roboto',sans-serif;
      transition: background .3s, color .3s, font-size .3s;
    }
    body.default-theme { background:#fff; color:#000; }
    body.dark-theme    { background:#222; color:#eee; }
    body.light-theme   { background:#f9f9f9; color:#000; }

    .navbar { background:#E5E8E8; padding:1rem; }
    .navbar ul { display:flex; gap:1rem; margin:0; padding:0; list-style:none; }
    .navbar a {
      text-decoration:none; color:black; cursor:pointer;
    }
    .navbar a.active { font-weight:bold; color:darkblue; }
    .navbar a:hover  { color:darkblue; }

    .view {
      position:absolute; top:60px; left:0; right:0; bottom:0;
      padding:10px; opacity:0; pointer-events:none;
      transform:translateY(10px);
      transition: opacity .3s, transform .3s;
      box-sizing:border-box; overflow:auto;
    }
    .view.active {
      opacity:1; pointer-events:auto;
      transform:translateY(0);
    }

    table { width:100%; border-collapse:collapse; margin-bottom:8px; }
    th, td { padding:4px 8px; }
    #word-count-divider { border-top:1px dashed grey; opacity:.7; }

    .tooltip { font-size:12px; color:grey; margin-top:8px; }

    .bar-container { width:100%; background:#ddd; border-radius:10px; margin:8px 0; }
    .bar {
      height:20px; border-radius:10px; line-height:20px;
      text-align:right; padding-right:5px; color:#fff;
      transition: width .5s;
    }
    .expected { background:var(--expected-color); width:0; }
    .actual   { background:var(--actual-color);   width:0; }

    form div { margin-bottom:8px; }
    label { margin-right:8px; }
    textarea { width:100%; box-sizing:border-box; }
    button { cursor:pointer; margin:4px 2px; }
  </style>
</head>
<body class="default-theme" style="font-size:14px">

  <!-- NAV BAR -->
  <nav class="navbar">
    <ul>
      <li><a id="home-nav"     href="#" onclick="showView('home',event)"    class="active">Home</a></li>
      <li><a id="gemini-nav"   href="#" onclick="showView('gemini',event)">Gemini</a></li>
      <li><a id="progress-nav" href="#" onclick="showView('progress',event)">Progress</a></li>
      <li><a id="settings-nav" href="#" onclick="showView('settings',event)">Settings</a></li>
    </ul>
  </nav>

  <div id="content-container">
    <!-- HOME VIEW -->
    <div id="home-view" class="view active">
      <h2>Welcome to Advanced Word Analysis</h2>
      <p><em>(Configure under Settings.)</em></p>
      <table>
        <tr><td>Word Count</td><td id="wordCount">…</td></tr>
        <tr><td>Sentence Count*</td><td id="sentenceCount">…</td></tr>
        <tr><td>Paragraph Count**</td><td id="paragraphCount">…</td></tr>
        <tr><td>Top-N Frequent Words</td><td id="topNWords">…</td></tr>
        <tr><td>Most Reused Word</td><td id="reusedWord">…</td></tr>
        <tr><td id="word-count-divider" colspan="2"></td></tr>
        <tr><td>Selected Words</td><td id="selectWords">0</td></tr>
        <tr><td>Selected Sentences</td><td id="selectSentence">0</td></tr>
        <tr><td>Selected Paragraphs</td><td id="selectParagraph">0</td></tr>
      </table>
      <button onclick="refreshSelectionStats()">Count Selection</button>
      <div class="tooltip">* ends in .!?  ** non-empty normal paragraphs</div>

      <div id="section-breakdown">
        <h3>Section Breakdown</h3>
        <table>
          <thead><tr><th>Section title</th><th>Word Count</th></tr></thead>
          <tbody id="sectionRows"></tbody>
        </table>
      </div>

      <button id="refreshStatsBtn" onclick="refreshAllStats()" style="margin-top:6px">
        Refresh Stats
      </button>
    </div>

    <!-- GEMINI VIEW -->
    <div id="gemini-view" class="view">
      <h2>Gemini Writing Tools</h2>
      <p>Select text then choose a tool:</p>
      <button onclick="runWritingTool('summarize')">Summarize</button>
      <button onclick="runWritingTool('friendly')">Make Friendly</button>
      <button onclick="runWritingTool('professional')">Make Professional</button>
      <button onclick="runWritingTool('concise')">Make Concise</button>
      <hr>
      <input type="text" id="geminiPrompt" style="width:80%" placeholder="Your prompt">
      <button onclick="getGeminiResponse()">Send</button>
      <div id="geminiResponse" style="margin-top:10px;"></div>
    </div>

    <!-- PROGRESS VIEW -->
    <div id="progress-view" class="view">
      <h2>Writing Progress</h2>
      <div><strong>Expected Progress</strong></div>
      <div class="bar-container"><div id="expectedBar" class="bar expected">0%</div></div>
      <div><strong>Actual Progress</strong></div>
      <div class="bar-container"><div id="actualBar" class="bar actual">0%</div></div>
      <button onclick="updateExpectedProgress()">Update Expected</button>
      <button onclick="updateProgress()">Update Actual</button>

      <h3>Set Progress Goals</h3>
      <form id="progressSettingsForm" onsubmit="saveProgressSettingsClient();return false;">
        <div>
          <label for="startDate">Start Date:</label><br>
          <input type="datetime-local" id="startDate">
        </div>
        <div>
          <label for="endDate">End Date:</label><br>
          <input type="datetime-local" id="endDate">
        </div>
        <div>
          <label for="wordGoal">Expected Word Count:</label><br>
          <input type="number" id="wordGoal" min="1">
        </div>
        <button type="submit">Save Progress</button>
      </form>
    </div>

    <!-- SETTINGS VIEW -->
    <div id="settings-view" class="view">
      <h2>Settings</h2>
      <form id="settingsForm">
        <div>
          <label><input type="checkbox" id="displayHomeInfo"> Show Home Section</label>
        </div>
        <div>
          <label><input type="checkbox" id="showSectionBreakdown"> Show Section Breakdown</label>
        </div>
        <div>
          <label for="topNWordsSetting">Top-N Frequent Words:</label>
          <input type="number" id="topNWordsSetting" min="1">
        </div>
        <div>
          <label for="topNDisplay">Display Mode:</label>
          <select id="topNDisplay">
            <option value="both">Words & Counts</option>
            <option value="words">Words Only</option>
            <option value="counts">Counts Only</option>
          </select>
        </div>
        <div>
          <label for="customExclusions">Custom Exclusions (comma-sep):</label><br>
          <textarea id="customExclusions" rows="2"></textarea>
        </div>
        <div>
          <label for="fontSize">Font Size (px, ≥15):</label>
          <input type="number" id="fontSize" min="15">
        </div>
        <div>
          <label for="themeColor">Theme:</label>
          <select id="themeColor">
            <option value="default">Default</option>
            <option value="dark">Dark</option>
            <option value="light">Light</option>
          </select>
        </div>
        <div>
          <label for="accentColor">Accent Color:</label>
          <select id="accentColor">
            <option value="default">Default</option>
            <option value="blue">Blue</option>
            <option value="red">Red</option>
            <option value="green">Green</option>
          </select>
        </div>
        <button type="button" onclick="saveSettings()">Save Settings</button>
      </form>
    </div>
  </div>

  <script>
    // --- NAVIGATION ---
    function showView(id,e){
      e.preventDefault();
      document.querySelectorAll('.navbar a').forEach(a=>a.classList.remove('active'));
      document.getElementById(id + '-nav').classList.add('active');
      document.querySelectorAll('.view').forEach(v=>{
        if(v.id === id + '-view') v.classList.add('active');
        else                     v.classList.remove('active');
      });
      if(id === 'settings') loadSettings();
      if(id === 'home')     refreshAllStats();
    }

    // --- HOME STATS ---
    function getWordCount(){
      google.script.run.withSuccessHandler(c=>{
        document.getElementById('wordCount').innerText = c;
      }).wordCount();
    }
    function getSentenceCount(){
      google.script.run.withSuccessHandler(c=>{
        document.getElementById('sentenceCount').innerText = c;
      }).sentenceCount();
    }
    function getParagraphCount(){
      google.script.run.withSuccessHandler(c=>{
        document.getElementById('paragraphCount').innerText = c;
      }).paragraphCount();
    }
    function getReusedWord(){
      google.script.run.withSuccessHandler(r=>{
        document.getElementById('reusedWord').innerText = `"${r.maxWord}" (${r.data[r.maxWord]})`;
      }).mostReusedWords();
    }
    function getTopNWords(n){
      google.script.run.withSuccessHandler(arr=>{
        const mode = document.getElementById('topNDisplay').value;
        let text = '';
        if(mode === 'both')   text = arr.map(o=>`${o.word} (${o.count})`).join(', ');
        else if(mode==='words') text = arr.map(o=>o.word).join(', ');
        else if(mode==='counts')text = arr.map(o=>o.count).join(', ');
        document.getElementById('topNWords').innerText = text;
      }).topFrequentWords(n);
    }
    function refreshAllStats(){
      getWordCount();
      getSentenceCount();
      getParagraphCount();
      getReusedWord();
      const n = parseInt(document.getElementById('topNWordsSetting').value,10) || 1;
      getTopNWords(n);
      google.script.run.withSuccessHandler(secs=>{
        const tbody = document.getElementById('sectionRows');
        tbody.innerHTML = '';
        secs.forEach(({title,wordCount})=>{
          if(!title.trim()) return;
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${title}</td><td>${wordCount}</td>`;
          tbody.append(tr);
        });
      }).countWordsBySmartSections();
    }
    function refreshSelectionStats(){
      google.script.run.withSuccessHandler(s=>{
        document.getElementById('selectWords').innerText     = s.wordCount;
        document.getElementById('selectSentence').innerText  = s.sentenceCount;
        document.getElementById('selectParagraph').innerText = s.paragraphCount;
      }).countWordsSelected();
    }

    // --- GEMINI ---
    function runWritingTool(tool){
      google.script.run.withSuccessHandler(txt=>{
        const prompts = {
          summarize:   'Summarize this text: ',
          friendly:    'Make this text friendly: ',
          professional:'Make this text professional: ',
          concise:     'Make this text concise: '
        };
        google.script.run.withSuccessHandler(resp=>{
          google.script.run.insertTextAfterSelection(resp);
        }).callGemini(prompts[tool] + txt);
      }).getSelectedText();
    }
    function getGeminiResponse(){
      const p = document.getElementById('geminiPrompt').value;
      document.getElementById('geminiResponse').innerText = 'Loading…';
      google.script.run.withSuccessHandler(r=>{
        document.getElementById('geminiResponse').innerText = r;
      }).callGemini(p);
    }

    // --- PROGRESS ---
    function updateExpectedProgress(){
      google.script.run.withSuccessHandler(d=>{
        const e = document.getElementById('expectedBar');
        e.style.width = d.percent + '%';
        e.innerText   = d.percent + '%';
      }).getExpectedProgressData();
    }
    function updateProgress(){
      google.script.run.withSuccessHandler(d=>{
        const a = document.getElementById('actualBar');
        a.style.width = d.percent + '%';
        a.innerText   = d.percent + '%';
      }).getProgressData();
    }
    function saveProgressSettingsClient(){
      const start = document.getElementById('startDate').value,
            end   = document.getElementById('endDate').value,
            g     = parseInt(document.getElementById('wordGoal').value,10);
      google.script.run.withSuccessHandler(()=>{
        updateExpectedProgress();
        updateProgress();
      }).saveProgressSettings(start,end,g);
    }

    // --- SETTINGS ---
    function loadSettings(){
      google.script.run.withSuccessHandler(s=>{
        document.getElementById('displayHomeInfo').checked       = s.displayHomeInfo;
        document.getElementById('showSectionBreakdown').checked = s.showSectionBreakdown;
        document.getElementById('topNWordsSetting').value      = s.topNWords;
        document.getElementById('topNDisplay').value           = s.topNDisplayOption;
        document.getElementById('customExclusions').value      = s.customExclusions;
        document.getElementById('fontSize').value              = s.fontSize;
        document.getElementById('themeColor').value            = s.themeColor;
        document.getElementById('accentColor').value           = s.accentColor;
        applySettings(s);
      }).getSettings();
    }
    function applySettings(s){
      document.getElementById('home-view').style.display         = s.displayHomeInfo ? '' : 'none';
      document.getElementById('section-breakdown').style.display = s.showSectionBreakdown ? '' : 'none';
      document.body.style.fontSize = s.fontSize + 'px';
      document.body.classList.remove('default-theme','dark-theme','light-theme');
      document.body.classList.add(s.themeColor+'-theme');
      const map = {
        default:{exp:'#8888ff',act:'#66cc66'},
        blue:   {exp:'#4285F4',act:'#0F9D58'},
        red:    {exp:'#EA4335',act:'#FBBC05'},
        green:  {exp:'#0F9D58',act:'#34A853'}
      }[s.accentColor] || {exp:'#8888ff',act:'#66cc66'};
      document.documentElement.style.setProperty('--expected-color',map.exp);
      document.documentElement.style.setProperty('--actual-color',map.act);
    }
    function saveSettings(){
      let fs = parseInt(document.getElementById('fontSize').value,10);
      if(isNaN(fs)||fs<15) fs=15;

      const s = {
        displayHomeInfo:      document.getElementById('displayHomeInfo').checked,
        showSectionBreakdown: document.getElementById('showSectionBreakdown').checked,
        topNWords:            parseInt(document.getElementById('topNWordsSetting').value,10)||3,
        topNDisplayOption:    document.getElementById('topNDisplay').value,
        customExclusions:     document.getElementById('customExclusions').value.trim(),
        fontSize:             fs,
        themeColor:           document.getElementById('themeColor').value,
        accentColor:          document.getElementById('accentColor').value
      };
      google.script.run.withSuccessHandler(msg=>{
        alert(msg);
        // Switch back to Home and refresh stats:
        showView('home', new Event('init'));
        refreshAllStats();
      }).saveSettings(s);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded',()=>{
      showView('home',new Event('init'));
      loadSettings();
      refreshAllStats();
      updateExpectedProgress();
      updateProgress();
    });
  </script>
</body>
</html>
